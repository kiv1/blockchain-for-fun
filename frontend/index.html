<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Blockchain - Charity on Ethereum</title>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css"/>
</head>
<body class="py-4">
  <section id="invalid-metamask-banner" class="hero is-warning is-hidden">
    <div class="hero-body">
      <p class="title">
        Metamask not detected
      </p>
      <p class="subtitle">
        Please install metamask extension before donating.
      </p>
    </div>
  </section>

  <div id="donation-contents" class="container is-hidden">
    <!-- Connected wallet banner -->
    <section class="hero is-info">
      <div class="hero-body">
        <p id="account-connected" class="title"></p>
      </div>
    </section>

    <!-- Send money to charity -->
    <div class="card mt-5">
      <div class="card-content">
        <form id="donation-form">
          <h1 class="is-size-1">Donation form</h1>

          <div class="field">
            <label class="label">Charity</label>
            <div class="control select">
              <select id="charity-option" name="charity"></select>
            </div>
          </div>

          <div class="field">
            <label class="label">Amount</label>
            <div class="control">
              <input id="amount-input" class="input" type="number" step=".001" placeholder="Amount to donate">
            </div>
          </div>

          <button class="button is-info">
            Donate
          </button>
        </form>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/web3/1.8.0/web3.min.js" integrity="sha512-bSQ2kf76XufUYS/4XinoHLp5S4lNOyRv0/x5UJACiOMy8ueqTNwRFfUZWmWpwnczjRp9SjiF1jrXbGEim7Y0Xg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.1/jquery.min.js" integrity="sha512-aVKKRRi/Q/YV+4mjoKBsE4x3H+BkegoM/em46NNlCqNTmUYADjBbeNefNxYV7giUp0VxICtqdrbqU7iVaeZNXA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script>
    const app = {
      ETHER_TO_WEI: 1000000000000000000,

      connectedAccount: null,

      hasMetaMaskInstalled: true,

      charities: [
        { address: "0x9FA4912Ce7b2Dbe22a2200FA6cd67BeAAc33b404", name: "Charity One" },
        { address: "0x42bB850EDA1Ef3677a813Af68A863E843406A926", name: "Charity Two" },
        { address: "0x2dfbff8A0F38F5701BaA84B5Dda4eDfb2a062327", name: "Charity Three" },
      ],

      contractAddress: "0xbA60a75D6491D6922031E2702514d582a4082Ce0",
      
      abi: [
        {
          "inputs": [
            {
              "internalType": "address payable[]",
              "name": "addresses_",
              "type": "address[]"
            }
          ],
          "stateMutability": "nonpayable",
          "type": "constructor"
        },
        {
          "anonymous": false,
          "inputs": [
            {
              "indexed": true,
              "internalType": "address",
              "name": "_donor",
              "type": "address"
            },
            {
              "indexed": false,
              "internalType": "uint256",
              "name": "_value",
              "type": "uint256"
            }
          ],
          "name": "Donation",
          "type": "event"
        },
        {
          "inputs": [
            {
              "internalType": "address payable",
              "name": "destinationAddress",
              "type": "address"
            },
            {
              "internalType": "uint256",
              "name": "charityIndex",
              "type": "uint256"
            },
            {
              "internalType": "uint256",
              "name": "donationAmount",
              "type": "uint256"
            }
          ],
          "name": "deposit",
          "outputs": [],
          "stateMutability": "payable",
          "type": "function"
        },
        {
          "inputs": [
            {
              "internalType": "address payable",
              "name": "destinationAddress",
              "type": "address"
            },
            {
              "internalType": "uint256",
              "name": "charityIndex",
              "type": "uint256"
            }
          ],
          "name": "deposit",
          "outputs": [],
          "stateMutability": "payable",
          "type": "function"
        },
        {
          "inputs": [],
          "name": "getAddresses",
          "outputs": [
            {
              "internalType": "address payable[]",
              "name": "",
              "type": "address[]"
            }
          ],
          "stateMutability": "view",
          "type": "function"
        },
        {
          "inputs": [],
          "name": "getTotalDonationsAmount",
          "outputs": [
            {
              "internalType": "uint256",
              "name": "",
              "type": "uint256"
            }
          ],
          "stateMutability": "view",
          "type": "function"
        },
        {
          "inputs": [],
          "name": "getHighestDonation",
          "outputs": [
            {
              "internalType": "uint256",
              "name": "",
              "type": "uint256"
            },
            {
              "internalType": "address payable",
              "name": "",
              "type": "address"
            }
          ],
          "stateMutability": "view",
          "type": "function"
        },
        {
          "inputs": [],
          "name": "destroy",
          "outputs": [],
          "stateMutability": "nonpayable",
          "type": "function"
        }
      ],

      contract: null,

      ensureMetaMaskInstalled: function () {
        this.hasMetaMaskInstalled = typeof window.ethereum !== 'undefined'
      },

      setupListeners: async function() {
        if (!this.hasMetaMaskInstalled) {
          $("#invalid-metamask-banner").removeClass("is-hidden")
          return
        }

        $("#donation-contents").removeClass("is-hidden")
        const accounts = await ethereum.request({ method: 'eth_requestAccounts' });
        this.connectedAccount = accounts[0];

        $("#donation-form").submit(event => {
          event.preventDefault()
          this.onDonationSubmit()
        })
      },

      setupInitialDisplay: function() {
        $("#account-connected").text(`Connected to ${this.connectedAccount}`)

        this.charities.forEach(function({ address, name }) {
          $("#charity-option").append(`<option value="${address}">${name}</option>`)
        })
      },

      onDonationSubmit: async function() {
        const selectedCharity = $("#charity-option").val()
        const selectedCharityIndex = this.charities.findIndex(({ address }) => address === selectedCharity)
        const selectedAmount = $("#amount-input").val()

        // TODO: Send donation transaction
        window.web3 = await new Web3(ethereum)
        this.contract = await new web3.eth.Contract(this.abi, this.contractAddress)

        if (!this.contract) {
          alert("Failed to establish connection to contract")
          return
        }

        this.contract.methods.deposit(selectedCharity, selectedCharityIndex)
          .send({ from: this.connectedAccount, gasLimit: 150000, value: selectedAmount * this.ETHER_TO_WEI }, this.depositCallback)
      },

      depositCallback: function(err, response) {
        if (err) {
          console.error("An error occured", err)
          return
        }

        console.log("Transaction successful", response)
      }
    }

    app.ensureMetaMaskInstalled()
    app.setupListeners()
      .then(function() {
        app.setupInitialDisplay()
      })
      .catch(function(e) {
        console.log("failed to setup listeners", e)
        alert("failed to connect wallet")
      })
  </script>
</body>
</html>